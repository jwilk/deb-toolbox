#!/usr/bin/python3
# encoding=UTF-8

# Copyright Â© 2011-2026 Jakub Wilk <jwilk@jwilk.net>
# SPDX-License-Identifier: MIT

import argparse
import getpass
import json
import re
import sys
import urllib.parse
import urllib.request

0_0  # Python >= 3.6 is required

user_agent = urllib.request.build_opener()
user_agent.addheaders[:] = [
    ('Content-Type', 'application/json; charset=UTF-8'),
]

def do_get_languages(options):
    url = urllib.parse.urljoin(options.server, '/api/v1/langs')
    request = urllib.request.Request(url)
    response = user_agent.open(request)
    data = json.load(response)
    for lang in sorted(d['code'] for d in data):
        print(lang)

def do_create_paste(options):
    text = options.text
    if text is None:
        text = sys.stdin.read()
    data = dict(
        code=text,
        poster=options.username,
        expire=options.expire,
    )
    if options.language:
        data.update(lang=options.language)
    data = json.dumps(data, ensure_ascii=False).encode('UTF-8')
    url = urllib.parse.urljoin(options.server, '/api/v1/paste')
    request = urllib.request.Request(url, data=data)
    response = user_agent.open(request)
    data = json.load(response)
    print(data['url'])

def parse_time_delta(s):
    item_re = '[0-9]+[smhd]'
    if not re.fullmatch(f'({item_re})+', s):
        raise ValueError
    dt = 0
    for item in re.findall(item_re, s):
        n = int(item[:-1])
        unit = item[-1]
        dt += n * dict(
            d = 24 * 60 * 60,
            h =      60 * 60,
            m =           60,
            s =            1,
        )[unit]
    return dt
parse_time_delta.__name__ = 'time'

def main():
    default_server = 'https://paste.debian.net/'
    default_username = getpass.getuser()
    default_expire = parse_time_delta('48h')
    parser = argparse.ArgumentParser()
    parser.add_argument('-S', '--server', metavar='URL', default=default_server, help=f'paste server (default: {default_server})')
    parser.add_argument('-u', '--username', default=default_username, help=f'name of the submitter (default: {default_username})')
    parser.add_argument('-l', '--language', default='text', help='highlighting language')
    parser.add_argument('-e', '--expire', type=parse_time_delta, default=default_expire, help=f'when the entry should expire (default: {default_expire // (60 * 60)}h)')
    parser.add_argument('-L', '--list-languages', action='store_true', help='list all supported highlighting languages')
    parser.add_argument('text', metavar='TEXT', nargs='?', help='text to paste (default: read text from stdin)')
    options = parser.parse_args()
    if options.list_languages:
        do_get_languages(options)
    else:
        do_create_paste(options)

if __name__ == '__main__':
    main()

# vim:ts=4 sts=4 sw=4 et
